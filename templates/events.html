<!--
    This is an HTML template for a Flask application's
    Events page within the Volunteer Management System.
    It is adapted from the organizations page template,
    with content and functionality changed to display events.
    The styling is handled using Tailwind CSS for a modern and
    fully responsive design.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteer Management System - Events</title>
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font from Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        .notification {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header Section -->
    <header class="bg-emerald-500 text-white p-6 text-center rounded-b-xl shadow-lg">
        <h1 class="text-4xl font-bold">Community Connect: Volunteer Management System</h1>
        <p class="mt-2 text-xl font-light">Connecting Volunteers, Organisations, and Events</p>
    </header>

    <!-- Navigation Bar -->
    <nav class="bg-gray-800 p-2 text-center shadow-md">
        <div class="max-w-4xl mx-auto flex justify-center space-x-6">
            <a href="/" class="text-white hover:text-emerald-300 font-medium transition-colors">Home</a>
            <a href="/organisations" class="text-white hover:text-emerald-300 font-medium transition-colors">View Organisations</a>
            <a href="/events" class="text-emerald-300 font-bold transition-colors">View Upcoming Events</a>
            
            {% if session["user_type"] %}
                <!-- Volunteer Specific Links -->
                {% if session["user_type"] == "volunteer" %}
                    <a href="/view_signups" class="text-white hover:text-emerald-300 font-medium transition-colors">My Signups</a>
                    <a href="/edit_profile" class="text-white hover:text-emerald-300 font-medium transition-colors">Edit Profile</a>
                    <a href="/logout" class="text-white hover:text-emerald-300 font-medium transition-colors">Log Out</a>
                <!-- Organization Specific Links -->
                {% elif session["user_type"] == "organisation" %}
                    <a href="/view_signups" class="text-white hover:text-emerald-300 font-medium transition-colors">Signups</a>
                    <a href="/edit_profile" class="text-white hover:text-emerald-300 font-medium transition-colors">Edit Profile</a>
                    <a href="/logout" class="text-white hover:text-emerald-300 font-medium transition-colors">Log Out</a>
                {% endif %}
            {% else %}
                <!-- Links for non-logged-in users -->
                <a href="/signup" class="text-white hover:text-emerald-300 font-medium transition-colors">Sign Up</a>
                <a href="/log_in" class="text-white hover:text-emerald-300 font-medium transition-colors">Log In</a>
            {% endif %}
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="p-8 flex-grow">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">
                {% if session["user_type"] == "organisation" %}
                    Your Events
                {% else %}
                    Upcoming Events
                {% endif %}
            </h2>

            <section>
                <!-- Organisation-specific view -->
                {% if session["user_type"] == "organisation" %}
                    <div class="text-center mb-6">
                        <button id="add-event-btn" class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                            Add New Event
                        </button>
                    </div>

                    <!-- Events Grid for Organisations -->
                    <div id="events-grid-org" class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for event in events %}
                            <div class="event-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 cursor-pointer"
                                data-event-id="{{ event['Id'] }}"
                                data-event-name="{{ event['Name'] }}"
                                data-event-description="{{ event['Description'] }}"
                                data-event-date="{{ event['Date'] }}">
                                <h3 class="text-xl font-semibold mb-2 text-gray-900">{{ event['Name'] }}</h3>
                                <p class="text-gray-600 text-sm mb-1">{{ event['Date'] }}</p>
                                <p class="text-gray-600 truncate">{{ event['Description'] }}</p>
                                <div class="mt-4 flex justify-end">
                                    <form action="/events" method="POST" class="delete-form">
                                        <input type="hidden" name="event_id" value="{{ event['Id'] }}">
                                        <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-colors">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                <!-- Volunteer-specific view -->
                {% else %}

                {% if session['user_type'] == 'volunteer' %}
                    <div class="text-center mb-6">
                        <button id="toggle-events-btn" class="bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors shadow-md">
                            Filter by My Skills
                        </button>
                    </div>
                {% endif %}
                    <!-- Events Grid with Jinja2 Loop for Volunteers -->
                    <div id="events-grid-volunteer" class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for event in events %}
                            <div class="event-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 cursor-pointer transition-transform transform hover:scale-105"
                                data-event-id="{{ event['Id'] }}"
                                data-event-name="{{ event['Name'] }}"
                                data-event-description="{{ event['Description'] }}"
                                data-event-date="{{ event['Date'] }}">
                                <h3 class="text-xl font-semibold mb-2 text-gray-900">{{ event['Name'] }}</h3>
                                <p class="text-gray-600 text-sm mb-1">{{ event['Date'] }}</p>
                                <p class="text-gray-600 truncate">{{ event['Description'] }}</p>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </section>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white p-4 text-center mt-auto shadow-inner rounded-t-xl">
        <p>&copy; 2025 Volunteer Management System</p>
    </footer>

    <!-- Modal Pop-up (hidden by default) -->
    <div id="modal-backdrop" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 hidden transition-opacity duration-300 opacity-0">
        <div id="modal-content" class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full transform transition-transform duration-300 scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-900"></h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Modal content will be populated dynamically by JavaScript -->
            <div id="modal-body" class="space-y-4"></div>
        </div>
    </div>
    
    <!-- Notification Pop-up (hidden by default) -->
    <div id="registration-notification" class="notification fixed bottom-4 right-4 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-xl z-50">
        <p id="notification-text"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get references to DOM elements
            const modalBackdrop = document.getElementById('modal-backdrop');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const notification = document.getElementById('registration-notification');
            const notificationText = document.getElementById('notification-text');
            const userType = "{{ session.get('user_type', 'none') }}"; // Get user type from Flask session

            const addEventBtn = document.getElementById('add-event-btn');
            const toggleEventsBtn = document.getElementById('toggle-events-btn');

            let isFilteredView = false;
            
            // Function to show the main modal
            function showModal() {
                modalBackdrop.classList.remove('hidden', 'opacity-0');
                modalBackdrop.classList.add('flex', 'opacity-100');
                modalBackdrop.querySelector('#modal-content').classList.remove('scale-95');
                modalBackdrop.querySelector('#modal-content').classList.add('scale-100');
            }

            // Function to hide the main modal
            function hideModal() {
                modalBackdrop.classList.remove('opacity-100');
                modalBackdrop.classList.add('opacity-0');
                modalBackdrop.querySelector('#modal-content').classList.remove('scale-100');
                modalBackdrop.querySelector('#modal-content').classList.add('scale-95');

                setTimeout(() => {
                    modalBackdrop.classList.remove('flex');
                    modalBackdrop.classList.add('hidden');
                    modalBody.innerHTML = ''; // Clear modal content on close
                }, 300);
            }

            // Function to show a temporary notification
            function showNotification(message) {
                notificationText.textContent = message;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000); // Notification disappears after 3 seconds
            }

            // Event listeners to close the modal
            closeModalBtn.addEventListener('click', hideModal);
            modalBackdrop.addEventListener('click', (e) => {
                if (e.target.id === 'modal-backdrop') {
                    hideModal();
                }
            });

            /**
             * Fetches and renders the latest events for the organization.
             * This function is crucial for providing real-time updates without a page reload.
             */
            async function renderOrgEvents() {
                try {
                    const response = await fetch('/get_org_events');
                    if (!response.ok) {
                        throw new Error('Failed to fetch events.');
                    }
                    const events = await response.json();
                    const eventsGrid = document.getElementById('events-grid-org');
                    eventsGrid.innerHTML = ''; // Clear existing content

                    if (events.length > 0) {
                        events.forEach(event => {
                            const eventCard = document.createElement('div');
                            eventCard.className = "event-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 cursor-pointer";
                            eventCard.dataset.eventId = event.Id;
                            eventCard.dataset.eventName = event.Name;
                            eventCard.dataset.eventDescription = event.Description;
                            eventCard.dataset.eventDate = event.Date;

                            // Construct the inner HTML
                            eventCard.innerHTML = `
                                <h3 class="text-xl font-semibold mb-2 text-gray-900">${event.Name}</h3>
                                <p class="text-gray-600 text-sm mb-1">${event.Date}</p>
                                <p class="text-gray-600 truncate">${event.Description}</p>
                                <div class="mt-4 flex justify-end">
                                    <form action="/events" method="POST" class="delete-form">
                                        <input type="hidden" name="event_id" value="${event.Id}">
                                        <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-colors">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            `;
                            eventsGrid.appendChild(eventCard);
                        });
                        // Re-attach listeners to the new cards
                        attachCardListeners();
                    } else {
                        eventsGrid.innerHTML = `<p class="text-gray-500 text-center col-span-full">No events have been created yet.</p>`;
                    }
                } catch (error) {
                    console.error("Error fetching and rendering events:", error);
                }
            }

            // New helper function to fetch and display roles inside the modal
            async function fetchAndRenderRoles(eventId) {
                try {
                    const rolesResponse = await fetch(`/get_org_event_roles?event_id=${eventId}`);
                    if (rolesResponse.ok) {
                        const roles = await rolesResponse.json();
                        const rolesList = document.getElementById('existing-roles-list');
                        if (rolesList) {
                            rolesList.innerHTML = ''; // Clear the loading message
                            if (roles.length > 0) {
                                roles.forEach(role => {
                                    const roleHtml = `
                                        <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                                            <h5 class="font-semibold text-gray-900">${role.name}</h5>
                                            <p class="text-sm text-gray-600">${role.description}</p>
                                            ${role.required_skill_name ? `<p class="text-xs text-gray-500 mt-1">Required Skill: ${role.required_skill_name}</p>` : ''}
                                        </div>
                                    `;
                                    rolesList.innerHTML += roleHtml;
                                });
                            } else {
                                rolesList.innerHTML = `<p class="text-gray-500 text-sm">No roles have been added yet.</p>`;
                            }
                        }
                    } else {
                        console.error('Failed to load event roles.');
                    }
                } catch (error) {
                    console.error('Error fetching roles:', error);
                }
            }
            
            // Function to attach click listeners to event cards and delete forms
            function attachCardListeners() {
                document.querySelectorAll('.event-card').forEach(card => {
                    card.addEventListener('click', handleCardClick);
                });
                document.querySelectorAll('.delete-form').forEach(form => {
                    form.addEventListener('submit', handleFormSubmit);
                });
            }

            // Logic for all event cards
            async function handleCardClick() {
                const eventId = this.getAttribute('data-event-id');
                const eventName = this.getAttribute('data-event-name');
                const eventDescription = this.getAttribute('data-event-description');
                const eventDate = this.getAttribute('data-event-date');
                if (userType === 'organisation') {
                    // Organization's event management pop-up
                    modalTitle.textContent = `Manage ${eventName}`;
                    modalBody.innerHTML = `
                        <form id="edit-event-form" class="space-y-4 mb-4">
                            <input type="hidden" name="event_id" value="${eventId}">
                            <div>
                                <label for="event_description" class="block text-gray-700 font-medium mb-1">Edit Description</label>
                                <textarea id="event_description" name="description" rows="4" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500">${eventDescription}</textarea>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                                Save Changes
                            </button>
                        </form>
                        
                        <hr class="my-4 border-gray-300">

                        <div class="mt-4">
                            <h4 class="text-xl font-bold text-gray-900 mb-2">Existing Roles</h4>
                            <div id="existing-roles-list" class="space-y-4">
                                <p class="text-gray-500 text-sm">Loading roles...</p>
                            </div>
                        </div>
                        
                        <hr class="my-4 border-gray-300">

                        <button id="add-role-btn" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors shadow-md">
                            Add Event Role
                        </button>
                    `;
                    showModal();

                    // Initial fetch and display of roles
                    fetchAndRenderRoles(eventId);

                    // Add event listener for the edit description form
                    document.getElementById('edit-event-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        try {
                            const response = await fetch('/edit_event', {
                                method: 'POST',
                                body: formData
                            });
                            if (response.ok) {
                                showNotification('Event description updated!');
                                hideModal();
                                renderOrgEvents(); // Rerender the events grid after a successful update
                            } else {
                                console.error('Failed to update event.');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    });
                    
                    // Add event listener for the "Add Event Role" button
                    document.getElementById('add-role-btn').addEventListener('click', async () => {
                        modalTitle.textContent = `Add Role to ${eventName}`;
                        
                        // Fetch all available skills from the database
                        const skillsResponse = await fetch('/get_skills');
                        const skills = await skillsResponse.json();
                        
                        let skillsOptionsHtml = '<option value="">(No required skill)</option>';
                        skills.forEach(skill => {
                            skillsOptionsHtml += `<option value="${skill.id}">${skill.name}</option>`;
                        });

                        modalBody.innerHTML = `
                            <form id="add-role-form" class="space-y-4">
                                <input type="hidden" name="event_id" value="${eventId}">
                                <div>
                                    <label for="role_name" class="block text-gray-700 font-medium mb-1">Role Name</label>
                                    <input type="text" id="role_name" name="role_name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" required>
                                </div>
                                <div>
                                    <label for="role_description" class="block text-gray-700 font-medium mb-1">Role Description</label>
                                    <textarea id="role_description" name="role_description" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" required></textarea>
                                </div>
                                <div>
                                    <label for="skill_id" class="block text-gray-700 font-medium mb-1">Required Skill</label>
                                    <select id="skill_id" name="skill_id" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500">
                                        ${skillsOptionsHtml}
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                                    Add Role
                                </button>
                            </form>
                        `;

                        // Add event listener for the new form
                        document.getElementById('add-role-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            try {
                                const response = await fetch('/add_event_role', {
                                    method: 'POST',
                                    body: formData
                                });
                                if (response.ok) {
                                    showNotification(`Role "${formData.get('role_name')}" added!`);
                                    e.target.reset(); // Clear form fields for next entry
                                    // Re-render the roles list within the modal
                                    fetchAndRenderRoles(eventId);
                                } else {
                                    console.error('Failed to add role.');
                                }
                            } catch (error) {
                                console.error('Error:', error);
                            }
                        });
                    });

                } else if (userType === 'volunteer') {
                    // Volunteer's event details pop-up
                    modalTitle.textContent = eventName;
                    modalBody.innerHTML = `
                        <div>
                            <p class="text-gray-600 font-semibold">Description:</p>
                            <p class="mt-1 text-gray-700">${eventDescription}</p>
                        </div>
                        <div class="mt-4">
                            <p class="text-gray-600 font-semibold">Date:</p>
                            <p class="mt-1 text-gray-700">${eventDate}</p>
                        </div>
                        <div class="mt-4">
                            <h4 class="text-xl font-bold text-gray-900 mb-2">Available Roles</h4>
                            <div id="roles-list" class="space-y-4">
                                <p class="text-gray-500 text-sm">Loading roles...</p>
                            </div>
                        </div>
                    `;
                    showModal();

                    // Fetch and display roles for the volunteer
                    try {
                        const rolesResponse = await fetch(`/get_event_roles?event_id=${eventId}`);
                        if (rolesResponse.ok) {
                            // Extract roles and volunteer skills from the new JSON payload
                            const data = await rolesResponse.json();
                            const roles = data.roles;
                            const volunteerSkills = data.volunteer_skills;
                            
                            const rolesList = document.getElementById('roles-list');
                            rolesList.innerHTML = '';
                            if (roles.length > 0) {
                                roles.forEach(role => {
                                    let actionButton;
                                    
                                    // Check if the volunteer has the required skill for this role
                                    const hasRequiredSkills = !role.required_skill_name || volunteerSkills.includes(role.required_skill_name);

                                    // Check the volunteer's signup status for this role
                                    if (role.signup_status === 'Pending') {
                                        actionButton = `<span class="px-4 py-2 rounded-lg text-sm bg-blue-500 text-white cursor-not-allowed">Pending</span>`;
                                    } else if (role.signup_status === 'Confirmed') {
                                        actionButton = `<span class="px-4 py-2 rounded-lg text-sm bg-green-600 text-white cursor-not-allowed">Confirmed</span>`;
                                    } else if (role.signup_status === 'Rejected') {
                                        actionButton = `<span class="px-4 py-2 rounded-lg text-sm bg-red-500 text-white cursor-not-allowed">Rejected</span>`;
                                    } else if (!hasRequiredSkills) {
                                        actionButton = `<span class="px-4 py-2 rounded-lg text-sm bg-gray-400 text-white cursor-not-allowed">Skills Needed</span>`;
                                    } else {
                                        actionButton = `<button class="register-role-btn bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-emerald-700 transition-colors" data-role-id="${role.id}" data-role-name="${role.name}">Sign Up</button>`;
                                    }

                                    const roleHtml = `
                                        <div class="bg-gray-100 p-4 rounded-lg shadow-inner flex justify-between items-center">
                                            <div>
                                                <h5 class="font-semibold text-gray-900">${role.name}</h5>
                                                <p class="text-sm text-gray-600">${role.description}</p>
                                                ${role.required_skill_name ? `<p class="text-xs text-gray-500 mt-1">Required Skill: ${role.required_skill_name}</p>` : ''}
                                            </div>
                                            ${actionButton}
                                        </div>
                                    `;
                                    rolesList.innerHTML += roleHtml;
                                });

                                // Add event listeners only to the new "Sign Up" buttons
                                document.querySelectorAll('.register-role-btn').forEach(btn => {
                                    btn.addEventListener('click', async () => {
                                        const roleId = btn.getAttribute('data-role-id');
                                        const roleName = btn.getAttribute('data-role-name');
                                        
                                        const formData = new FormData();
                                        formData.append('role_id', roleId);
                                        
                                        try {
                                            const response = await fetch('/register_for_role', {
                                                method: 'POST',
                                                body: formData,
                                            });
                                            if (response.ok) {
                                                showNotification(`Signed up for "${roleName}"!`);
                                                hideModal();
                                            } else {
                                                const errorText = await response.text();
                                                showNotification(errorText); // Display error from backend
                                                console.error('Registration failed:', errorText);
                                            }
                                        } catch (error) {
                                            console.error('Error:', error);
                                        }
                                    });
                                });
                            } else {
                                rolesList.innerHTML = `<p class="text-gray-500 text-sm">No roles available for this event yet.</p>`;
                            }
                        } else {
                            console.error('Failed to load event roles.');
                        }
                    } catch (error) {
                        console.error('Error fetching roles:', error);
                    }
                }
            }
            
            // Logic to handle form submissions for delete events
            async function handleFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                
                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                    });
                    
                    if (response.ok) {
                        showNotification('Event deleted successfully!');
                        // Remove the event card from the DOM
                        const eventCard = form.closest('.event-card');
                        if (eventCard) {
                            eventCard.remove();
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Failed to delete event:', errorText);
                        showNotification('Failed to delete event.');
                    }
                } catch (error) {
                    console.error('Error deleting event:', error);
                    showNotification('Error deleting event.');
                }
            }

            // New logic to handle the add event form submission
            if (addEventBtn) {
                addEventBtn.addEventListener('click', () => {
                    modalTitle.textContent = 'Add New Event';
                    modalBody.innerHTML = `
                        <form id="add-event-form" class="space-y-4">
                            <div>
                                <label for="event_name" class="block text-gray-700 font-medium mb-1">Event Name</label>
                                <input type="text" id="event_name" name="name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" required>
                            </div>
                            <div>
                                <label for="event_date" class="block text-gray-700 font-medium mb-1">Date</label>
                                <input type="date" id="event_date" name="date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" required>
                            </div>
                            <div>
                                <label for="event_location" class="block text-gray-700 font-medium mb-1">Location</label>
                                <input type="text" id="event_location" name="location" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" required>
                            </div>
                            <div>
                                <label for="event_starttime" class="block text-gray-700 font-medium mb-1">Start Time</label>
                                <input type="time" id="event_starttime" name="starttime" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" required>
                            </div>
                            <div>
                                <label for="event_endtime" class="block text-gray-700 font-medium mb-1">End Time</label>
                                <input type="time" id="event_endtime" name="endtime" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" required>
                            </div>
                            <div>
                                <label for="event_description" class="block text-gray-700 font-medium mb-1">Description</label>
                                <textarea id="event_description" name="description" rows="4" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" required></textarea>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                                Add Event
                            </button>
                        </form>
                    `;
                    showModal();
                    // Add event listener for the new form
                    document.getElementById('add-event-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        try {
                            const response = await fetch('/add_event', {
                                method: 'POST',
                                body: formData
                            });
                            if (response.ok) {
                                showNotification('Event added!');
                                hideModal();
                                renderOrgEvents(); // Rerender the events grid after a successful update
                            } else {
                                console.error('Failed to add event.');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    });
                });
            }

            // New logic to handle the event filtering for volunteers
            if (toggleEventsBtn) {
                toggleEventsBtn.addEventListener('click', async () => {
                    isFilteredView = !isFilteredView; // Toggle the view state
                    
                    const eventCards = document.querySelectorAll('#events-grid-volunteer .event-card');
                    toggleEventsBtn.textContent = isFilteredView ? 'Loading...' : 'Filter by My Skills';
                    toggleEventsBtn.disabled = true;

                    for (const card of eventCards) {
                        if (isFilteredView) {
                            // Fetch skills for this specific event to determine if it should be shown
                            const eventId = card.dataset.eventId;
                            try {
                                const response = await fetch(`/get_event_roles?event_id=${eventId}`);
                                if (response.ok) {
                                    const data = await response.json();
                                    const volunteerSkills = data.volunteer_skills;
                                    const hasMatchingRole = data.roles.some(role => {
                                        // Check if the role has a required skill and if the volunteer has it
                                        return role.required_skill_name && volunteerSkills.includes(role.required_skill_name);
                                    });

                                    // If no matching roles, hide the card
                                    if (!hasMatchingRole) {
                                        card.style.display = 'none';
                                    } else {
                                        card.style.display = ''; // Show the card if it has a matching role
                                    }
                                }
                            } catch (error) {
                                console.error(`Error fetching skills for event ${eventId}:`, error);
                                card.style.display = 'none'; // Hide on error
                            }
                        } else {
                            // Show all events if the filter is off
                            card.style.display = '';
                        }
                    }

                    // Update button text and state after all cards have been processed
                    toggleEventsBtn.textContent = isFilteredView ? 'Show All Events' : 'Filter by My Skills';
                    toggleEventsBtn.disabled = false;
                });
            }

            // Initial call to attach listeners to existing cards
            attachCardListeners();
        });
    </script>
</body>
</html>
